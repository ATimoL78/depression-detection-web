<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢éƒ¨è¯†åˆ«æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #video {
            width: 100%;
            max-width: 640px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        #canvas {
            width: 100%;
            max-width: 640px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .video-container {
            position: relative;
            display: inline-block;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ é¢éƒ¨è¯†åˆ«åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. æ‘„åƒå¤´è®¿é—®æµ‹è¯•</h2>
            <button id="testCamera">æµ‹è¯•æ‘„åƒå¤´</button>
            <button id="stopCamera" disabled>åœæ­¢æ‘„åƒå¤´</button>
            <div id="cameraStatus"></div>
            <div class="video-container" style="margin-top: 10px;">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="canvas" class="overlay"></canvas>
            </div>
        </div>

        <div class="test-section">
            <h2>2. MediaPipeèµ„æºæ£€æŸ¥</h2>
            <button id="checkMediaPipe">æ£€æŸ¥MediaPipeæ–‡ä»¶</button>
            <div id="mediapipeStatus"></div>
        </div>

        <div class="test-section">
            <h2>3. ç³»ç»Ÿä¿¡æ¯</h2>
            <div id="systemInfo"></div>
        </div>

        <div class="test-section">
            <h2>4. æµ‹è¯•æ—¥å¿—</h2>
            <pre id="logs"></pre>
        </div>
    </div>

    <script>
        const logs = [];
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            document.getElementById('logs').textContent = logs.join('\n');
            console.log(logMessage);
        }

        // ç³»ç»Ÿä¿¡æ¯
        document.getElementById('systemInfo').innerHTML = `
            <div class="status info">
                <strong>æµè§ˆå™¨:</strong> ${navigator.userAgent}<br>
                <strong>æ”¯æŒgetUserMedia:</strong> ${navigator.mediaDevices ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                <strong>æ”¯æŒCanvas:</strong> ${document.createElement('canvas').getContext ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                <strong>HTTPS:</strong> ${location.protocol === 'https:' ? 'âœ… æ˜¯' : 'âš ï¸ å¦ (localhosté™¤å¤–)'}<br>
            </div>
        `;

        // æµ‹è¯•æ‘„åƒå¤´
        let stream = null;
        document.getElementById('testCamera').addEventListener('click', async () => {
            const statusDiv = document.getElementById('cameraStatus');
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            try {
                log('å¼€å§‹è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                statusDiv.innerHTML = '<div class="status info">â³ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...</div>';
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: "user"
                    }
                });
                
                log('âœ… æ‘„åƒå¤´è®¿é—®æˆåŠŸ');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    log(`è§†é¢‘å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}`);
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    statusDiv.innerHTML = `
                        <div class="status success">
                            âœ… æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ<br>
                            åˆ†è¾¨ç‡: ${video.videoWidth}x${video.videoHeight}<br>
                            å¸§ç‡: ${stream.getVideoTracks()[0].getSettings().frameRate || 'N/A'} fps
                        </div>
                    `;
                    
                    document.getElementById('testCamera').disabled = true;
                    document.getElementById('stopCamera').disabled = false;
                    
                    // ç®€å•çš„äººè„¸æ¡†ç»˜åˆ¶æµ‹è¯•
                    drawTestBox();
                };
                
            } catch (error) {
                log(`âŒ æ‘„åƒå¤´é”™è¯¯: ${error.message}`);
                statusDiv.innerHTML = `
                    <div class="status error">
                        âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥<br>
                        é”™è¯¯: ${error.name} - ${error.message}
                    </div>
                `;
            }
        });

        // åœæ­¢æ‘„åƒå¤´
        document.getElementById('stopCamera').addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                document.getElementById('video').srcObject = null;
                document.getElementById('cameraStatus').innerHTML = '<div class="status info">æ‘„åƒå¤´å·²åœæ­¢</div>';
                document.getElementById('testCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
                log('æ‘„åƒå¤´å·²åœæ­¢');
            }
        });

        // ç»˜åˆ¶æµ‹è¯•æ¡†
        function drawTestBox() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            function draw() {
                if (!stream) return;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶ä¸­å¿ƒæµ‹è¯•æ¡†
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const boxSize = 200;
                
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 3;
                ctx.strokeRect(centerX - boxSize/2, centerY - boxSize/2, boxSize, boxSize);
                
                ctx.fillStyle = '#00ff00';
                ctx.font = '16px Arial';
                ctx.fillText('è¯·å°†é¢éƒ¨å¯¹å‡†æ­¤æ¡†', centerX - 80, centerY - boxSize/2 - 10);
                
                requestAnimationFrame(draw);
            }
            
            draw();
        }

        // æ£€æŸ¥MediaPipeæ–‡ä»¶
        document.getElementById('checkMediaPipe').addEventListener('click', async () => {
            const statusDiv = document.getElementById('mediapipeStatus');
            statusDiv.innerHTML = '<div class="status info">â³ æ­£åœ¨æ£€æŸ¥MediaPipeæ–‡ä»¶...</div>';
            
            const files = [
                '/mediapipe/face_mesh.js',
                '/mediapipe/face_mesh_solution_simd_wasm_bin.wasm',
                '/mediapipe/face_mesh_solution_wasm_bin.wasm',
                '/mediapipe/face_mesh_solution_packed_assets.data'
            ];
            
            let html = '<div class="status info"><strong>MediaPipeæ–‡ä»¶æ£€æŸ¥:</strong><br>';
            let allOk = true;
            
            for (const file of files) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        html += `âœ… ${file} (${response.headers.get('content-length')} bytes)<br>`;
                        log(`âœ… ${file} å­˜åœ¨`);
                    } else {
                        html += `âŒ ${file} (HTTP ${response.status})<br>`;
                        log(`âŒ ${file} ä¸å­˜åœ¨`);
                        allOk = false;
                    }
                } catch (error) {
                    html += `âŒ ${file} (ç½‘ç»œé”™è¯¯)<br>`;
                    log(`âŒ ${file} æ£€æŸ¥å¤±è´¥: ${error.message}`);
                    allOk = false;
                }
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
            
            if (allOk) {
                log('âœ… æ‰€æœ‰MediaPipeæ–‡ä»¶æ£€æŸ¥é€šè¿‡');
            } else {
                log('âš ï¸ éƒ¨åˆ†MediaPipeæ–‡ä»¶ç¼ºå¤±æˆ–æ— æ³•è®¿é—®');
            }
        });

        log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
